<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Factory UI - Test Suite</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        .test-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        .test-results {
            margin-top: 1rem;
        }
        .test-pass {
            color: var(--status-success);
        }
        .test-fail {
            color: var(--status-error);
        }
        .test-pending {
            color: var(--status-warning);
        }
        .test-log {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-primary);
            border-radius: 4px;
            padding: 1rem;
            margin-top: 1rem;
            font-family: var(--font-mono);
            font-size: var(--text-sm);
            white-space: pre-wrap;
        }
        .test-button {
            background: var(--accent-primary);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .test-button:hover {
            background: #3a8eef;
        }
        .test-button:disabled {
            background: var(--status-neutral);
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>Factory UI - Test Suite</h1>
        <p>Comprehensive testing for Git-based Requirements Management System</p>

        <!-- Git Operations Tests -->
        <section class="test-section">
            <h2>Git Operations Tests</h2>
            <p>Test Git API integration and data operations</p>
            <button class="test-button" onclick="runGitTests()">Run Git Tests</button>
            <button class="test-button" onclick="runAllTests()">Run All Tests</button>
            <div id="gitTestResults" class="test-results"></div>
            <div id="gitTestLog" class="test-log" style="display: none;"></div>
        </section>

        <!-- UI Component Tests -->
        <section class="test-section">
            <h2>UI Component Tests</h2>
            <p>Test role-based UI rendering and interactions</p>
            <button class="test-button" onclick="runUITests()">Run UI Tests</button>
            <div id="uiTestResults" class="test-results"></div>
            <div id="uiTestLog" class="test-log" style="display: none;"></div>
        </section>

        <!-- Integration Tests -->
        <section class="test-section">
            <h2>Integration Tests</h2>
            <p>Test end-to-end workflows and data flow</p>
            <button class="test-button" onclick="runIntegrationTests()">Run Integration Tests</button>
            <div id="integrationTestResults" class="test-results"></div>
            <div id="integrationTestLog" class="test-log" style="display: none;"></div>
        </section>

        <!-- Performance Tests -->
        <section class="test-section">
            <h2>Performance Tests</h2>
            <p>Test UI responsiveness and data loading performance</p>
            <button class="test-button" onclick="runPerformanceTests()">Run Performance Tests</button>
            <div id="performanceTestResults" class="test-results"></div>
            <div id="performanceTestLog" class="test-log" style="display: none;"></div>
        </section>

        <!-- Test Summary -->
        <section class="test-section">
            <h2>Test Summary</h2>
            <div id="testSummary">
                <p>No tests run yet. Click "Run All Tests" to execute the complete test suite.</p>
            </div>
        </section>
    </div>

    <script src="git-api.js"></script>
    <script src="app.js"></script>
    <script>
        // Test Suite Implementation
        class TestSuite {
            constructor() {
                this.results = {
                    git: { passed: 0, failed: 0, total: 0, tests: [] },
                    ui: { passed: 0, failed: 0, total: 0, tests: [] },
                    integration: { passed: 0, failed: 0, total: 0, tests: [] },
                    performance: { passed: 0, failed: 0, total: 0, tests: [] }
                };
                this.gitAPI = new GitAPI();
                this.factoryUI = null;
            }

            log(message, category = 'info') {
                console.log(`[${category.toUpperCase()}] ${message}`);
            }

            async runTest(testName, testFunction, category) {
                try {
                    this.log(`Running test: ${testName}`, 'test');
                    const result = await testFunction();
                    if (result) {
                        this.results[category].passed++;
                        this.log(`‚úì PASS: ${testName}`, 'pass');
                        return { name: testName, status: 'pass', message: 'Test passed' };
                    } else {
                        this.results[category].failed++;
                        this.log(`‚úó FAIL: ${testName}`, 'fail');
                        return { name: testName, status: 'fail', message: 'Test failed' };
                    }
                } catch (error) {
                    this.results[category].failed++;
                    this.log(`‚úó ERROR: ${testName} - ${error.message}`, 'error');
                    return { name: testName, status: 'fail', message: error.message };
                } finally {
                    this.results[category].total++;
                }
            }

            displayResults(category, elementId, logId) {
                const results = this.results[category];
                const element = document.getElementById(elementId);
                const logElement = document.getElementById(logId);
                
                let html = `<h3>${category.toUpperCase()} Test Results</h3>`;
                html += `<p><strong>Total:</strong> ${results.total} | <strong>Passed:</strong> <span class="test-pass">${results.passed}</span> | <strong>Failed:</strong> <span class="test-fail">${results.failed}</span></p>`;
                
                if (results.tests.length > 0) {
                    html += '<ul>';
                    results.tests.forEach(test => {
                        const statusClass = test.status === 'pass' ? 'test-pass' : 'test-fail';
                        html += `<li class="${statusClass}">${test.status.toUpperCase()}: ${test.name}</li>`;
                        if (test.message) {
                            html += `<li style="margin-left: 1rem; color: var(--text-secondary); font-size: 0.9em;">${test.message}</li>`;
                        }
                    });
                    html += '</ul>';
                }
                
                element.innerHTML = html;
                
                // Show log if there are failures
                if (results.failed > 0) {
                    logElement.style.display = 'block';
                    logElement.textContent = results.tests
                        .filter(test => test.status === 'fail')
                        .map(test => `${test.name}: ${test.message}`)
                        .join('\n');
                } else {
                    logElement.style.display = 'none';
                }
            }

            updateSummary() {
                const summary = document.getElementById('testSummary');
                const total = Object.values(this.results).reduce((acc, cat) => ({
                    passed: acc.passed + cat.passed,
                    failed: acc.failed + cat.failed,
                    total: acc.total + cat.total
                }), { passed: 0, failed: 0, total: 0 });

                let html = '<h3>Overall Test Summary</h3>';
                html += `<p><strong>Total Tests:</strong> ${total.total}</p>`;
                html += `<p><strong>Passed:</strong> <span class="test-pass">${total.passed}</span></p>`;
                html += `<p><strong>Failed:</strong> <span class="test-fail">${total.failed}</span></p>`;
                html += `<p><strong>Success Rate:</strong> ${total.total > 0 ? ((total.passed / total.total) * 100).toFixed(1) : 0}%</p>`;

                if (total.failed === 0 && total.total > 0) {
                    html += '<p class="test-pass"><strong>üéâ All tests passed!</strong></p>';
                } else if (total.failed > 0) {
                    html += '<p class="test-fail"><strong>‚ö†Ô∏è Some tests failed. Check the logs above for details.</strong></p>';
                }

                summary.innerHTML = html;
            }
        }

        // Initialize test suite
        const testSuite = new TestSuite();

        // Git Operations Tests
        async function runGitTests() {
            testSuite.results.git = { passed: 0, failed: 0, total: 0, tests: [] };

            // Test 1: Get Issues
            const test1 = await testSuite.runTest('Get Issues', async () => {
                const issues = await testSuite.gitAPI.getIssues();
                return Array.isArray(issues) && issues.length > 0;
            }, 'git');
            testSuite.results.git.tests.push(test1);

            // Test 2: Create Issue
            const test2 = await testSuite.runTest('Create Issue', async () => {
                const newIssue = await testSuite.gitAPI.createIssue({
                    title: 'Test Issue',
                    body: 'This is a test issue created by the test suite',
                    labels: ['artifact:BRS', 'status:Draft', 'priority:Low']
                });
                return newIssue && newIssue.title === 'Test Issue';
            }, 'git');
            testSuite.results.git.tests.push(test2);

            // Test 3: Update Issue
            const test3 = await testSuite.runTest('Update Issue', async () => {
                const issues = await testSuite.gitAPI.getIssues();
                const firstIssue = issues[0];
                const updated = await testSuite.gitAPI.updateIssue(firstIssue.number, {
                    state: 'closed'
                });
                return updated && updated.state === 'closed';
            }, 'git');
            testSuite.results.git.tests.push(test3);

            // Test 4: Search Issues
            const test4 = await testSuite.runTest('Search Issues', async () => {
                const results = await testSuite.gitAPI.searchIssues('electrolyzer');
                return results && results.total_count > 0;
            }, 'git');
            testSuite.results.git.tests.push(test4);

            // Test 5: Get Labels
            const test5 = await testSuite.runTest('Get Labels', async () => {
                const labels = await testSuite.gitAPI.getLabels();
                return Array.isArray(labels) && labels.length > 0;
            }, 'git');
            testSuite.results.git.tests.push(test5);

            // Test 6: Create Label
            const test6 = await testSuite.runTest('Create Label', async () => {
                const newLabel = await testSuite.gitAPI.createLabel({
                    name: 'test:automated',
                    color: 'ff6b6b',
                    description: 'Automated test label'
                });
                return newLabel && newLabel.name === 'test:automated';
            }, 'git');
            testSuite.results.git.tests.push(test6);

            // Test 7: Get Repository Stats
            const test7 = await testSuite.runTest('Get Repository Stats', async () => {
                const stats = await testSuite.gitAPI.getRepositoryStats();
                return stats && typeof stats.open_issues === 'number';
            }, 'git');
            testSuite.results.git.tests.push(test7);

            // Test 8: Get Content
            const test8 = await testSuite.runTest('Get Content', async () => {
                const content = await testSuite.gitAPI.getContent('/factory/governance.yml');
                return content && content.content;
            }, 'git');
            testSuite.results.git.tests.push(test8);

            testSuite.displayResults('git', 'gitTestResults', 'gitTestLog');
            testSuite.updateSummary();
        }

        // UI Component Tests
        async function runUITests() {
            testSuite.results.ui = { passed: 0, failed: 0, total: 0, tests: [] };

            // Initialize FactoryUI if not already done
            if (!testSuite.factoryUI) {
                testSuite.factoryUI = new FactoryUI();
            }

            // Test 1: Role Selection
            const test1 = await testSuite.runTest('Role Selection', async () => {
                testSuite.factoryUI.setRole('admin');
                return testSuite.factoryUI.currentRole === 'admin';
            }, 'ui');
            testSuite.results.ui.tests.push(test1);

            // Test 2: Navigation Rendering
            const test2 = await testSuite.runTest('Navigation Rendering', async () => {
                const nav = document.getElementById('sidebarNav');
                return nav && nav.children.length > 0;
            }, 'ui');
            testSuite.results.ui.tests.push(test2);

            // Test 3: Role Badge Update
            const test3 = await testSuite.runTest('Role Badge Update', async () => {
                const roleBadge = document.getElementById('roleBadge');
                return roleBadge && roleBadge.classList.contains('role-admin');
            }, 'ui');
            testSuite.results.ui.tests.push(test3);

            // Test 4: Page Navigation
            const test4 = await testSuite.runTest('Page Navigation', async () => {
                testSuite.factoryUI.navigateToPage('governance');
                return testSuite.factoryUI.currentPage === 'governance';
            }, 'ui');
            testSuite.results.ui.tests.push(test4);

            // Test 5: Content Rendering
            const test5 = await testSuite.runTest('Content Rendering', async () => {
                const contentGrid = document.getElementById('contentGrid');
                return contentGrid && contentGrid.innerHTML.length > 0;
            }, 'ui');
            testSuite.results.ui.tests.push(test5);

            // Test 6: Manager Role Switch
            const test6 = await testSuite.runTest('Manager Role Switch', async () => {
                testSuite.factoryUI.setRole('manager');
                return testSuite.factoryUI.currentRole === 'manager';
            }, 'ui');
            testSuite.results.ui.tests.push(test6);

            // Test 7: Operator Role Switch
            const test7 = await testSuite.runTest('Operator Role Switch', async () => {
                testSuite.factoryUI.setRole('operator');
                return testSuite.factoryUI.currentRole === 'operator';
            }, 'ui');
            testSuite.results.ui.tests.push(test7);

            // Test 8: QA Role Switch
            const test8 = await testSuite.runTest('QA Role Switch', async () => {
                testSuite.factoryUI.setRole('qa');
                return testSuite.factoryUI.currentRole === 'qa';
            }, 'ui');
            testSuite.results.ui.tests.push(test8);

            testSuite.displayResults('ui', 'uiTestResults', 'uiTestLog');
            testSuite.updateSummary();
        }

        // Integration Tests
        async function runIntegrationTests() {
            testSuite.results.integration = { passed: 0, failed: 0, total: 0, tests: [] };

            // Test 1: Git to UI Data Flow
            const test1 = await testSuite.runTest('Git to UI Data Flow', async () => {
                const issues = await testSuite.gitAPI.getIssues();
                const brsIssues = issues.filter(issue => 
                    issue.labels.includes('artifact:BRS')
                );
                return brsIssues.length > 0;
            }, 'integration');
            testSuite.results.integration.tests.push(test1);

            // Test 2: Issue Creation Workflow
            const test2 = await testSuite.runTest('Issue Creation Workflow', async () => {
                const newIssue = await testSuite.gitAPI.createIssue({
                    title: 'Integration Test Issue',
                    body: 'Created during integration testing',
                    labels: ['artifact:FRS', 'status:Draft', 'priority:Low']
                });
                
                // Verify it appears in the issues list
                const issues = await testSuite.gitAPI.getIssues();
                const found = issues.find(issue => issue.number === newIssue.number);
                return found !== undefined;
            }, 'integration');
            testSuite.results.integration.tests.push(test2);

            // Test 3: Label Management Workflow
            const test3 = await testSuite.runTest('Label Management Workflow', async () => {
                // Create a new label
                const newLabel = await testSuite.gitAPI.createLabel({
                    name: 'integration:test',
                    color: '00ff00',
                    description: 'Integration test label'
                });

                // Verify it's in the labels list
                const labels = await testSuite.gitAPI.getLabels();
                const found = labels.find(label => label.name === newLabel.name);
                return found !== undefined;
            }, 'integration');
            testSuite.results.integration.tests.push(test3);

            // Test 4: Multi-Role Data Access
            const test4 = await testSuite.runTest('Multi-Role Data Access', async () => {
                const issues = await testSuite.gitAPI.getIssues();
                
                // Admin should see all issues
                testSuite.factoryUI.setRole('admin');
                const adminView = testSuite.factoryUI.renderOverview();
                
                // Manager should see filtered view
                testSuite.factoryUI.setRole('manager');
                const managerView = testSuite.factoryUI.renderOverview();
                
                // Both views should contain some data
                return adminView.length > 0 && managerView.length > 0;
            }, 'integration');
            testSuite.results.integration.tests.push(test4);

            // Test 5: Issue Status Update Workflow
            const test5 = await testSuite.runTest('Issue Status Update Workflow', async () => {
                const issues = await testSuite.gitAPI.getIssues();
                const openIssue = issues.find(issue => issue.state === 'open');
                
                if (!openIssue) return false;
                
                // Update the issue
                const updated = await testSuite.gitAPI.updateIssue(openIssue.number, {
                    state: 'closed',
                    labels: [...openIssue.labels, 'status:Closed']
                });
                
                return updated.state === 'closed';
            }, 'integration');
            testSuite.results.integration.tests.push(test5);

            testSuite.displayResults('integration', 'integrationTestResults', 'integrationTestLog');
            testSuite.updateSummary();
        }

        // Performance Tests
        async function runPerformanceTests() {
            testSuite.results.performance = { passed: 0, failed: 0, total: 0, tests: [] };

            // Test 1: Page Load Performance
            const test1 = await testSuite.runTest('Page Load Performance', async () => {
                const startTime = performance.now();
                
                // Simulate page load
                testSuite.factoryUI.setRole('admin');
                testSuite.factoryUI.navigateToPage('overview');
                
                const endTime = performance.now();
                const loadTime = endTime - startTime;
                
                // Should load within 100ms for this demo
                return loadTime < 100;
            }, 'performance');
            testSuite.results.performance.tests.push(test1);

            // Test 2: Data Fetch Performance
            const test2 = await testSuite.runTest('Data Fetch Performance', async () => {
                const startTime = performance.now();
                
                const issues = await testSuite.gitAPI.getIssues();
                
                const endTime = performance.now();
                const fetchTime = endTime - startTime;
                
                // Should fetch within 500ms (includes mock delay)
                return fetchTime < 500;
            }, 'performance');
            testSuite.results.performance.tests.push(test2);

            // Test 3: UI Rendering Performance
            const test3 = await testSuite.runTest('UI Rendering Performance', async () => {
                const startTime = performance.now();
                
                // Render multiple pages
                const roles = ['admin', 'manager', 'operator', 'qa'];
                for (const role of roles) {
                    testSuite.factoryUI.setRole(role);
                    testSuite.factoryUI.renderOverview();
                }
                
                const endTime = performance.now();
                const renderTime = endTime - startTime;
                
                // Should render all roles within 200ms
                return renderTime < 200;
            }, 'performance');
            testSuite.results.performance.tests.push(test3);

            // Test 4: Memory Usage
            const test4 = await testSuite.runTest('Memory Usage', async () => {
                // Check if memory usage is reasonable
                if (performance.memory) {
                    const memoryUsage = performance.memory.usedJSHeapSize;
                    const memoryLimit = 50 * 1024 * 1024; // 50MB
                    return memoryUsage < memoryLimit;
                }
                return true; // Skip if memory API not available
            }, 'performance');
            testSuite.results.performance.tests.push(test4);

            testSuite.displayResults('performance', 'performanceTestResults', 'performanceTestLog');
            testSuite.updateSummary();
        }

        // Run All Tests
        async function runAllTests() {
            console.log('Running complete test suite...');
            
            await runGitTests();
            await runUITests();
            await runIntegrationTests();
            await runPerformanceTests();
            
            console.log('All tests completed!');
        }

        // Initialize the test page
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Test suite loaded and ready');
        });
    </script>
</body>
</html>
